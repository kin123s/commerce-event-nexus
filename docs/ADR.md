# Architecture Decision Records (ADR)

## ADR-001: Transactional Outbox Pattern 채택

### 상태
승인됨 (2026-02-02)

### 컨텍스트
마이크로서비스 환경에서 데이터베이스 업데이트와 이벤트 발행의 원자성을 보장해야 합니다.

### 결정
Transactional Outbox 패턴을 채택하여 같은 트랜잭션 내에서 비즈니스 데이터와 이벤트를 함께 저장합니다.

### 결과
**긍정적**:
- DB 업데이트와 이벤트 발행의 원자성 보장
- At-least-once 이벤트 전달 보장
- 메시지 손실 방지

**부정적**:
- 추가 테이블 필요 (outbox_events)
- Polling 또는 CDC 인프라 필요
- 약간의 지연 발생 가능

### 대안
1. **Dual Write**: 데이터 저장 후 바로 Kafka 발행 → 원자성 보장 불가
2. **Transaction Log Tailing**: DB 트랜잭션 로그 직접 읽기 → 복잡도 증가

---

## ADR-002: Choreography 기반 Saga Pattern

### 상태
승인됨 (2026-02-02)

### 컨텍스트
분산 트랜잭션을 관리하기 위한 방법이 필요합니다.

### 결정
Choreography 방식의 Saga Pattern을 채택하여 각 서비스가 이벤트를 발행하고 구독합니다.

### 결과
**긍정적**:
- 서비스 간 느슨한 결합
- 중앙 오케스트레이터 불필요
- 확장성 우수

**부정적**:
- 전체 플로우 파악이 어려움
- 순환 의존성 발생 가능
- 디버깅 복잡도 증가

### 대안
**Orchestration 기반 Saga**: 중앙 조율자가 플로우 관리 → 중앙 장애점 발생

---

## ADR-003: 멱등성 키 기반 중복 처리 방지

### 상태
승인됨 (2026-02-02)

### 컨텍스트
Kafka의 At-least-once 전달 보장으로 인해 중복 메시지가 발생할 수 있습니다.

### 결정
`processed_events` 테이블을 사용하여 이미 처리된 이벤트를 추적합니다.

### 결과
**긍정적**:
- Exactly-once 시맨틱 구현
- 중복 결제 방지
- 간단한 구현

**부정적**:
- 추가 테이블 및 조회 필요
- 데이터베이스 크기 증가

### 대안
1. **Kafka Transactions**: Producer/Consumer 트랜잭션 사용 → 복잡도 증가
2. **Redis 기반 중복 체크**: TTL 기반 캐시 사용 → 영속성 보장 어려움

---

## ADR-004: Testcontainers 통합 테스트

### 상태
승인됨 (2026-02-02)

### 컨텍스트
실제 인프라와 유사한 환경에서 통합 테스트가 필요합니다.

### 결정
Testcontainers를 사용하여 PostgreSQL, Kafka 컨테이너를 테스트 시 자동으로 시작합니다.

### 결과
**긍정적**:
- 실제 환경과 동일한 테스트
- Mocking 불필요
- CI/CD 파이프라인 통합 용이

**부정적**:
- 테스트 실행 시간 증가
- Docker 의존성

### 대안
**Mock 기반 테스트**: 가벼운 테스트 가능 → 실제 동작 보장 어려움
